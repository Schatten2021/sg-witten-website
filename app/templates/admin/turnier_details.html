{% extends 'base.html' %}
{% block head %}
	<style>
        .ffa-name-header {
            writing-mode: vertical-lr;
            text-orientation: mixed;
        }
        .won-KL {
            background-color: #0F0 !important;
        }
        .won {
            background-color: #0A0 !important;
        }
        .remi {
            background-color: #00A !important;
        }
        .lost {
            background-color: #A00 !important;
        }
        .lost-KL {
            background-color: #F00 !important;
        }
    </style>
{% endblock %}
{% block body %}
    <form id="form" method="post" action="/admin/turniere/{{ cup.id }}">
        <div id="general">
            <h1>
                <label>
                        <input type="text" value="{{ cup.name }}" name="name" required>
                </label>
            </h1>
            {# TODO: date input #}
            <label>
                Turnierart:
                <select name="turnier_type" id="turnier-art-select">
                    <option value="K.O." selected>K.O. Turnier</option>
                    <option value="Schweizer">Schweizer System</option>
                    <option value="jeder gegen jeden">Jeder gegen jeden</option>
                </select>
            </label>
        </div>
        <div id="">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th scope="col">Person</th>
                    </tr>
                </thead>
                <tbody id="personen-table-body">
                    <tr>
                        <td class="btn" onclick="addPerson()">+</td>
                    </tr>
                </tbody>
            </table>
            <div id="bp" style="display: none">
                <label>
                <select id="all_people">
                    {% for person in Person.query.all() %}
                        <option value="{{ person.id }}">{{ person.name }}, {{ person.surname }}</option>
                    {% endfor %}
                </select>
                <select id="possible_game_outcomes">
                    <option value=""></option>
                    <option value="-2">-</option>
                    <option value="-1">0</option>
                    <option value="0">½</option>
                    <option value="1">1</option>
                    <option value="2">+</option>
                </select>
            </label>
            </div>
        </div>
        <table id="legende" class="table table-bordered">
            <thead>
                <tr>
                    <td>Symbol</td>
                    <td>Bedeutung</td>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>+</td>
                    <td>kampfloser Sieg</td>
                </tr>
                <tr>
                    <td>1</td>
                    <td>Sieg</td>
                </tr>
                <tr>
                    <td>½</td>
                    <td>Remi</td>
                </tr>
                <tr>
                    <td>0</td>
                    <td>Niederlage</td>
                </tr>
                <tr>
                    <td>-</td>
                    <td>kampflose Niederlage</td>
                </tr>
            </tbody>
        </table>
        <div id="games">
            {# TODO: game input #}
        </div>
        <button type="submit" class="btn btn-primary">submit</button>
    </form>
{% endblock %}
{% block javascript %}
	<script>
        const form = document.getElementById("form")
        const personenDiv = document.getElementById("personen-table-body")
        const games = document.getElementById("games")
        const cup_type_input = document.getElementById("turnier-art-select")
        const personDropdownBP = document.getElementById("all_people")
        const resultDropdownBP = document.getElementById("possible_game_outcomes")
        cup_type_input.addEventListener("change", () => {
            switch (cup_type_input.value) {
                case "jeder gegen jeden":
                    renderFFA();
                    break
                default:
                    console.error(`"${cup_type_input}" has no rendering implementation`)
            }
        })
        function addPerson() {
            const addRow = personenDiv.children[personenDiv.children.length - 1];
            const newPerson = document.createElement("tr")
            const personDropdown = personDropdownBP.cloneNode(true)
            console.debug(personDropdown.style)
            console.debug(personDropdownBP)
            personDropdown.name = "teilnehmer" + (personenDiv.children.length - 1);
            personDropdown.id = "";
            personDropdown.addEventListener("change", updatePeople)
            newPerson.appendChild(document.createElement("td")).appendChild(personDropdown)
            personenDiv.insertBefore(newPerson, addRow)
            //TODO: add Verein selection
            //TODO: depending on the current cup type change the generated html
        }
        function updatePeople() {
            //TODO: implement checking and appropriate change of name update method
        }
        function renderFFA() {
            const table = document.createElement("table");
            table.className = "table table-bordered";
            console.debug("rendering FFA")
            let selectedPeople = []
            for (let i = 0; i < personenDiv.children.length - 1; i++) {
                const elem = personenDiv.children[i].firstChild.firstChild
                const selectedOption = elem.options[elem.selectedIndex].text
                selectedPeople.push(selectedOption)
            }
            // generate top row
            const topRow = document.createElement("tr")
            topRow.innerHTML += "<th>Namen</th>"
            for (let i = 0; i < selectedPeople.length; i++) {
                const currentHeader = document.createElement("th")
                currentHeader.innerText = selectedPeople[i];
                currentHeader.className = "ffa-name-header";
                currentHeader.scope = "col";
                topRow.appendChild(currentHeader);
            }
            table.appendChild(topRow)

            // generate rest of table
            for (let i = 0; i < selectedPeople.length; i++) {
                const currentRow = document.createElement("tr");
                const personHeader = document.createElement("th")
                personHeader.innerText = selectedPeople[i];
                personHeader.scope = "row";
                currentRow.appendChild(personHeader)
                for (let j = 0; j < selectedPeople.length; j++) {
                    const currentElement = document.createElement("td");
                    if (i === j) {
                        currentElement.innerText = "X";
                    } else {
                        const dropdown = resultDropdownBP.cloneNode(true);
                        dropdown.id = "";
                        const idkWhatToNameThis = {
                            "": {
                                "opposite": "",
                                "class": ""
                            },
                            "-2": {
                                "opposite": "2",
                                "class": "lost-KL"
                            },
                            "-1": {
                                "opposite": "1",
                                "class": "lost"
                            },
                            "0": {
                                "opposite": "0",
                                "class": "remi"
                            },
                            "1": {
                                "opposite": "-1",
                                "class": "won"
                            },
                            "2": {
                                "opposite": "-2",
                                "class": "won-KL"
                            }
                        }
                        dropdown.addEventListener("change", () => {
                            const opposite = idkWhatToNameThis[dropdown.value]
                            dropdown.className = opposite.class
                            table.children[j+1].children[i+1].firstChild.value = opposite.opposite;
                            table.children[j+1].children[i+1].firstChild.className = idkWhatToNameThis[opposite.opposite].class
                        })
                        dropdown.name = `game ${i}-${j}`
                        currentElement.appendChild(dropdown)
                    }
                    currentRow.appendChild(currentElement)
                }
                table.appendChild(currentRow)
            }
            games.innerHTML = "";
            games.appendChild(table)

            //TODO: change personen input
        }
        cup_type_input.select()
    </script>
{% endblock %}